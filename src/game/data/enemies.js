import {
  ORC_ASSET,
  ORC_ROGUE_ASSET,
  ORC_SHAMAN_ASSET,
  ORC_WARRIOR_ASSET,
  SKELETON_MAGE_ASSET,
  SKELETON_ROGUE_ASSET,
  SKELETON_WARRIOR_ASSET,
} from './constants'

const RAW_ENEMY_TEMPLATES = {
  ash_hound: {
    id: 'ash_hound',
    name: 'Chien des cendres',
    asset: ORC_ROGUE_ASSET,
    level: 2,
    maxHp: 84,
    maxMana: 30,
    attack: 14,
    defense: 8,
    speed: 11,
    ap: 5,
    mp: 3,
    xpReward: 55,
    goldReward: 24,
    weaponRangeMin: 1,
    weaponRangeMax: 1,
    fleeResist: 0.08,
    skills: [
      {
        id: 'hound_bite',
        name: 'Morsure',
        apCost: 3,
        manaCost: 0,
        minRange: 1,
        maxRange: 2,
        effect: 'damage',
        power: 1.1,
        cooldown: 1,
      },
      {
        id: 'hound_lunge',
        name: 'Bond',
        apCost: 4,
        manaCost: 0,
        minRange: 1,
        maxRange: 3,
        effect: 'damage',
        power: 1.45,
        cooldown: 2,
      },
    ],
  },
  shrouded_orc: {
    id: 'shrouded_orc',
    name: 'Orc de la brume',
    asset: ORC_ASSET,
    level: 3,
    maxHp: 108,
    maxMana: 36,
    attack: 16,
    defense: 10,
    speed: 8,
    ap: 5,
    mp: 2,
    xpReward: 66,
    goldReward: 30,
    weaponRangeMin: 1,
    weaponRangeMax: 1,
    fleeResist: 0.12,
    skills: [
      {
        id: 'orc_cleave',
        name: 'Fauchage',
        apCost: 3,
        manaCost: 0,
        minRange: 1,
        maxRange: 2,
        effect: 'damage',
        power: 1.2,
        cooldown: 1,
      },
      {
        id: 'orc_roar',
        name: 'Rugissement',
        apCost: 3,
        manaCost: 0,
        minRange: 0,
        maxRange: 0,
        effect: 'buff',
        buffType: 'attackPercent',
        buffValue: 0.18,
        buffTurns: 2,
        cooldown: 3,
      },
      {
        id: 'orc_throw',
        name: 'Hache lancee',
        apCost: 3,
        manaCost: 0,
        minRange: 2,
        maxRange: 4,
        effect: 'damage',
        power: 1.05,
        cooldown: 1,
      },
    ],
  },
  crypt_mage: {
    id: 'crypt_mage',
    name: 'Mage de crypte',
    asset: SKELETON_MAGE_ASSET,
    level: 5,
    maxHp: 116,
    maxMana: 95,
    attack: 18,
    defense: 10,
    speed: 9,
    ap: 6,
    mp: 2,
    xpReward: 84,
    goldReward: 36,
    weaponRangeMin: 2,
    weaponRangeMax: 3,
    fleeResist: 0.16,
    skills: [
      {
        id: 'crypt_bolt',
        name: 'Eclair mortuaire',
        apCost: 3,
        manaCost: 8,
        minRange: 2,
        maxRange: 6,
        effect: 'damage',
        power: 1.26,
        cooldown: 1,
      },
      {
        id: 'crypt_rot',
        name: 'Souillure',
        apCost: 4,
        manaCost: 11,
        minRange: 2,
        maxRange: 6,
        effect: 'dot',
        power: 0.62,
        dotKind: 'poison',
        impactPower: 0.4,
        dotTurns: 3,
        cooldown: 2,
      },
    ],
  },
  bone_guard: {
    id: 'bone_guard',
    name: 'Garde osseux',
    asset: SKELETON_WARRIOR_ASSET,
    level: 5,
    maxHp: 144,
    maxMana: 40,
    attack: 19,
    defense: 14,
    speed: 7,
    ap: 5,
    mp: 2,
    xpReward: 90,
    goldReward: 40,
    weaponRangeMin: 1,
    weaponRangeMax: 1,
    fleeResist: 0.18,
    skills: [
      {
        id: 'bone_slam',
        name: 'Heurt d os',
        apCost: 3,
        manaCost: 0,
        minRange: 1,
        maxRange: 2,
        effect: 'damage',
        power: 1.3,
        cooldown: 1,
      },
      {
        id: 'bone_wall',
        name: 'Mur ossuaire',
        apCost: 3,
        manaCost: 0,
        minRange: 0,
        maxRange: 0,
        effect: 'shield',
        shieldRatio: 0.28,
        cooldown: 3,
      },
      {
        id: 'bone_spear',
        name: 'Javelot osseux',
        apCost: 3,
        manaCost: 0,
        minRange: 2,
        maxRange: 4,
        effect: 'damage',
        power: 1.1,
        cooldown: 1,
      },
    ],
  },
  obsidian_reaper: {
    id: 'obsidian_reaper',
    name: 'Faucheur d obsidienne',
    asset: ORC_WARRIOR_ASSET,
    level: 8,
    maxHp: 168,
    maxMana: 64,
    attack: 22,
    defense: 16,
    speed: 10,
    ap: 6,
    mp: 3,
    xpReward: 128,
    goldReward: 56,
    weaponRangeMin: 1,
    weaponRangeMax: 2,
    fleeResist: 0.24,
    skills: [
      {
        id: 'reaper_hook',
        name: 'Crochet noir',
        apCost: 3,
        manaCost: 0,
        minRange: 2,
        maxRange: 5,
        effect: 'control',
        power: 1.05,
        pullDistance: 1,
        cooldown: 2,
      },
      {
        id: 'reaper_cut',
        name: 'Decoupe',
        apCost: 4,
        manaCost: 0,
        minRange: 1,
        maxRange: 2,
        effect: 'damage',
        power: 1.65,
        cooldown: 1,
      },
    ],
  },
  whisper_thief: {
    id: 'whisper_thief',
    name: 'Voleur spectral',
    asset: SKELETON_ROGUE_ASSET,
    level: 7,
    maxHp: 124,
    maxMana: 52,
    attack: 21,
    defense: 11,
    speed: 13,
    ap: 6,
    mp: 4,
    xpReward: 110,
    goldReward: 48,
    weaponRangeMin: 1,
    weaponRangeMax: 1,
    fleeResist: 0.2,
    skills: [
      {
        id: 'thief_sting',
        name: 'Piqure',
        apCost: 3,
        manaCost: 0,
        minRange: 1,
        maxRange: 2,
        effect: 'damage',
        power: 1.25,
        cooldown: 1,
      },
      {
        id: 'thief_bleed',
        name: 'Lame sale',
        apCost: 4,
        manaCost: 0,
        minRange: 1,
        maxRange: 2,
        effect: 'dot',
        power: 0.7,
        dotKind: 'bleed',
        impactPower: 0.55,
        dotTurns: 3,
        cooldown: 2,
      },
    ],
  },
  boss_ash_colossus: {
    id: 'boss_ash_colossus',
    name: 'Colosse cendre-noire',
    asset: ORC_WARRIOR_ASSET,
    level: 6,
    maxHp: 320,
    maxMana: 90,
    attack: 24,
    defense: 17,
    speed: 8,
    ap: 6,
    mp: 2,
    xpReward: 260,
    goldReward: 120,
    isBoss: true,
    weaponRangeMin: 1,
    weaponRangeMax: 2,
    fleeResist: 0.44,
    skills: [
      {
        id: 'colossus_crush',
        name: 'Ecrasement',
        apCost: 4,
        manaCost: 0,
        minRange: 1,
        maxRange: 2,
        effect: 'damage',
        power: 1.75,
        cooldown: 1,
      },
      {
        id: 'colossus_roar',
        name: 'Onde bestiale',
        apCost: 4,
        manaCost: 0,
        minRange: 2,
        maxRange: 5,
        effect: 'damage',
        power: 1.38,
        cooldown: 2,
      },
    ],
  },
  boss_bone_emperor: {
    id: 'boss_bone_emperor',
    name: 'Empereur des os',
    asset: SKELETON_WARRIOR_ASSET,
    level: 9,
    maxHp: 390,
    maxMana: 130,
    attack: 27,
    defense: 19,
    speed: 9,
    ap: 7,
    mp: 2,
    xpReward: 360,
    goldReward: 160,
    isBoss: true,
    weaponRangeMin: 1,
    weaponRangeMax: 2,
    fleeResist: 0.48,
    skills: [
      {
        id: 'emperor_slam',
        name: 'Jugement osseux',
        apCost: 4,
        manaCost: 0,
        minRange: 1,
        maxRange: 2,
        effect: 'damage',
        power: 1.82,
        cooldown: 1,
      },
      {
        id: 'emperor_hex',
        name: 'Hex de cendre froide',
        apCost: 4,
        manaCost: 18,
        minRange: 2,
        maxRange: 6,
        effect: 'dot',
        power: 0.86,
        dotKind: 'curse',
        impactPower: 0.55,
        dotTurns: 3,
        cooldown: 2,
      },
      {
        id: 'emperor_guard',
        name: 'Trone du neant',
        apCost: 3,
        manaCost: 0,
        minRange: 0,
        maxRange: 0,
        effect: 'shield',
        shieldRatio: 0.35,
        cooldown: 3,
      },
    ],
  },
  boss_obsidian_archon: {
    id: 'boss_obsidian_archon',
    name: 'Archonte d obsidienne',
    asset: ORC_SHAMAN_ASSET,
    level: 12,
    maxHp: 460,
    maxMana: 190,
    attack: 31,
    defense: 22,
    speed: 11,
    ap: 7,
    mp: 3,
    xpReward: 520,
    goldReward: 220,
    isBoss: true,
    weaponRangeMin: 2,
    weaponRangeMax: 3,
    fleeResist: 0.52,
    skills: [
      {
        id: 'archon_lance',
        name: 'Lance volcanique',
        apCost: 4,
        manaCost: 14,
        minRange: 2,
        maxRange: 6,
        effect: 'damage',
        power: 1.65,
        cooldown: 1,
      },
      {
        id: 'archon_storm',
        name: 'Tempete de schiste',
        apCost: 5,
        manaCost: 22,
        minRange: 2,
        maxRange: 7,
        effect: 'dot',
        power: 0.95,
        dotKind: 'burn',
        impactPower: 0.55,
        dotTurns: 3,
        cooldown: 2,
      },
      {
        id: 'archon_absorb',
        name: 'Absorption prismatique',
        apCost: 3,
        manaCost: 0,
        minRange: 0,
        maxRange: 0,
        effect: 'buff',
        buffType: 'defensePercent',
        buffValue: 0.3,
        buffTurns: 2,
        cooldown: 3,
      },
    ],
  },
  boss_mirror_eater: {
    id: 'boss_mirror_eater',
    name: 'Devorant des miroirs',
    asset: SKELETON_MAGE_ASSET,
    level: 11,
    maxHp: 420,
    maxMana: 170,
    attack: 29,
    defense: 18,
    speed: 13,
    ap: 7,
    mp: 4,
    xpReward: 470,
    goldReward: 198,
    isBoss: true,
    weaponRangeMin: 2,
    weaponRangeMax: 3,
    fleeResist: 0.5,
    skills: [
      {
        id: 'mirror_shard',
        name: 'Eclat reflet',
        apCost: 4,
        manaCost: 12,
        minRange: 2,
        maxRange: 7,
        effect: 'damage',
        power: 1.58,
        cooldown: 1,
      },
      {
        id: 'mirror_reflect',
        name: 'Reflexion hostile',
        apCost: 3,
        manaCost: 0,
        minRange: 0,
        maxRange: 0,
        effect: 'buff',
        buffType: 'counterDamagePercent',
        buffValue: 0.25,
        buffTurns: 2,
        cooldown: 3,
      },
    ],
  },
  boss_forge_titan: {
    id: 'boss_forge_titan',
    name: 'Titan de la forge oubliee',
    asset: ORC_ASSET,
    level: 13,
    maxHp: 510,
    maxMana: 120,
    attack: 34,
    defense: 24,
    speed: 8,
    ap: 7,
    mp: 2,
    xpReward: 560,
    goldReward: 260,
    isBoss: true,
    weaponRangeMin: 1,
    weaponRangeMax: 2,
    fleeResist: 0.56,
    skills: [
      {
        id: 'titan_hammer',
        name: 'Marteau infernal',
        apCost: 4,
        manaCost: 0,
        minRange: 1,
        maxRange: 2,
        effect: 'damage',
        power: 1.9,
        cooldown: 1,
      },
      {
        id: 'titan_fire',
        name: 'Fusion interne',
        apCost: 4,
        manaCost: 0,
        minRange: 0,
        maxRange: 0,
        effect: 'buff',
        buffType: 'attackPercent',
        buffValue: 0.35,
        buffTurns: 2,
        cooldown: 3,
      },
    ],
  },
}

const ENEMY_SKILL_STATUS_AUGMENTS = {
  hound_lunge: { statusEffect: { kind: 'topple', chance: 0.2, turns: 1, value: 1 } },
  orc_cleave: { statusEffect: { kind: 'weaken', chance: 0.18, turns: 1, value: 0.08 } },
  reaper_hook: { statusEffect: { kind: 'disorient', chance: 0.24, turns: 1, value: 1 } },
  emperor_slam: { statusEffect: { kind: 'topple', chance: 0.28, turns: 1, value: 1 } },
  archon_storm: { statusEffect: { kind: 'disorient', chance: 0.3, turns: 1, value: 1 } },
  titan_hammer: { statusEffect: { kind: 'topple', chance: 0.32, turns: 1, value: 1 } },
}

function cap(value, min, max) {
  return Math.min(max, Math.max(min, value))
}

function defaultEnemyCombatStats(template) {
  const level = template.level ?? 1
  const speedBias = template.speed >= 11 ? 0.03 : 0
  const tankBias = template.defense >= 16 ? 0.04 : 0
  const bossBias = template.isBoss ? 0.03 : 0
  return {
    critChance: cap(0.045 + level * 0.006 + bossBias, 0.04, 0.34),
    dodgeChance: cap(0.02 + level * 0.003 + speedBias, 0.02, 0.24),
    parryChance: cap(0.025 + level * 0.003 + tankBias, 0.02, 0.25),
    critDamage: cap(0.34 + level * 0.01 + bossBias * 0.8, 0.34, 0.7),
    toppleChance: cap(0.04 + level * 0.002 + bossBias * 0.5, 0.04, 0.2),
    statusResist: cap(0.04 + level * 0.009 + (template.isBoss ? 0.08 : 0), 0.04, 0.5),
  }
}

export const ENEMY_TEMPLATES = Object.fromEntries(
  Object.entries(RAW_ENEMY_TEMPLATES).map(([templateId, template]) => {
    const combatDefaults = defaultEnemyCombatStats(template)
    return [
      templateId,
      {
        ...template,
        ...combatDefaults,
        skills: (template.skills ?? []).map((skill) => ({
          ...skill,
          ...ENEMY_SKILL_STATUS_AUGMENTS[skill.id],
        })),
      },
    ]
  }),
)

export function getEnemyTemplateById(templateId) {
  return ENEMY_TEMPLATES[templateId] ?? null
}

export const MATERIAL_FROM_ENEMY = {
  ash_hound: [{ material: 'bone_dust', min: 1, max: 2, chance: 0.7 }],
  shrouded_orc: [{ material: 'ore', min: 1, max: 2, chance: 0.45 }],
  crypt_mage: [{ material: 'ether_drop', min: 1, max: 2, chance: 0.5 }],
  bone_guard: [{ material: 'bone_dust', min: 2, max: 3, chance: 0.85 }],
  obsidian_reaper: [{ material: 'obsidian_fragment', min: 1, max: 2, chance: 0.7 }],
  whisper_thief: [{ material: 'resin', min: 1, max: 2, chance: 0.55 }],
}

export const BOSS_DROP_SHARD_CHANCE = 1

